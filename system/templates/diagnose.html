{% extends "base.html" %}

{% block title %}患者诊断{% endblock %}

{% block content %}
<div class="card">
    <h2>患者诊断</h2>
    
    <h3>患者信息</h3>
    <table>
        <tr>
            <th>挂号ID</th>
            <td>{{ patient.registration_id }}</td>
        </tr>
        <tr>
            <th>患者姓名</th>
            <td>{{ patient.patient_name }}</td>
        </tr>
        <tr>
            <th>性别</th>
            <td>{{ patient.gender }}</td>
        </tr>
        <tr>
            <th>出生日期</th>
            <td>{{ patient.date_of_birth }}</td>
        </tr>
        <tr>
            <th>电话</th>
            <td>{{ patient.phone }}</td>
        </tr>
        <tr>
            <th>科室</th>
            <td>{{ patient.department_name }}</td>
        </tr>
        <tr>
            <th>医生</th>
            <td>{{ patient.doctor_name }}</td>
        </tr>
        <tr>
            <th>挂号日期</th>
            <td>{{ patient.registration_date }} {{ patient.registration_time }}</td>
        </tr>
        <tr>
            <th>主诉</th>
            <td>{{ patient.chief_complaint or '无' }}</td>
        </tr>
    </table>
</div>

<div class="card">
    <h3>处方表单</h3>
    <form method="POST" action="{{ url_for('diagnose', reg_id=reg_id) }}" id="prescriptionForm">
        <div id="prescriptionList">
            <div class="prescription-item" data-index="1">
                <h4>处方 #1</h4>
                <div class="form-group">
                    <label for="drug_id_1">药品：</label>
                    <select id="drug_id_1" name="drug_id_1" required>
                        <option value="">-- 请选择药品 --</option>
                        {% for drug in drugs %}
                            <option value="{{ drug.drug_id }}">
                                {{ drug.drug_name }} - {{ drug.specification }} (库存: {{ drug.stored_quantity }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="quantity_1">数量：</label>
                    <input type="number" id="quantity_1" name="quantity_1" min="1" required>
                </div>
                
                <div class="form-group">
                    <label for="dosage_1">用法用量：</label>
                    <input type="text" id="dosage_1" name="dosage_1" value="按医嘱" placeholder="按医嘱">
                </div>
                
                <div class="form-group">
                    <label for="duration_days_1">疗程（天）：</label>
                    <input type="number" id="duration_days_1" name="duration_days_1" value="7" min="1">
                </div>
                
                <div class="form-group">
                    <label for="notes_1">备注：</label>
                    <textarea id="notes_1" name="notes_1" rows="2"></textarea>
                </div>
                <hr>
            </div>
        </div>
        
        <button type="button" class="btn" onclick="addPrescription()">添加处方</button>
        <button type="submit" class="btn btn-success">提交诊断</button>
        <a href="{{ url_for('doctor_queue') }}" class="btn btn-danger">取消</a>
    </form>
</div>

<script>
    let prescriptionCount = 1;
    
    // Drug data from server (safe, server-side rendered)
    const drugOptions = [
        {% for drug in drugs %}
        {
            id: {{ drug.drug_id }},
            name: "{{ drug.drug_name|e }}",
            spec: "{{ drug.specification|e }}",
            stock: {{ drug.stored_quantity }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    function createPrescriptionElement(index) {
        // Create container
        const container = document.createElement('div');
        container.className = 'prescription-item';
        container.setAttribute('data-index', index);
        
        // Create title
        const title = document.createElement('h4');
        title.textContent = '处方 #' + index;
        container.appendChild(title);
        
        // Create drug selection field
        const drugGroup = document.createElement('div');
        drugGroup.className = 'form-group';
        
        const drugLabel = document.createElement('label');
        drugLabel.setAttribute('for', 'drug_id_' + index);
        drugLabel.textContent = '药品：';
        drugGroup.appendChild(drugLabel);
        
        const drugSelect = document.createElement('select');
        drugSelect.id = 'drug_id_' + index;
        drugSelect.name = 'drug_id_' + index;
        drugSelect.required = true;
        
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- 请选择药品 --';
        drugSelect.appendChild(defaultOption);
        
        drugOptions.forEach(drug => {
            const option = document.createElement('option');
            option.value = drug.id;
            option.textContent = drug.name + ' - ' + drug.spec + ' (库存: ' + drug.stock + ')';
            drugSelect.appendChild(option);
        });
        
        drugGroup.appendChild(drugSelect);
        container.appendChild(drugGroup);
        
        // Create quantity field
        const qtyGroup = document.createElement('div');
        qtyGroup.className = 'form-group';
        const qtyLabel = document.createElement('label');
        qtyLabel.setAttribute('for', 'quantity_' + index);
        qtyLabel.textContent = '数量：';
        qtyGroup.appendChild(qtyLabel);
        const qtyInput = document.createElement('input');
        qtyInput.type = 'number';
        qtyInput.id = 'quantity_' + index;
        qtyInput.name = 'quantity_' + index;
        qtyInput.min = '1';
        qtyInput.required = true;
        qtyGroup.appendChild(qtyInput);
        container.appendChild(qtyGroup);
        
        // Create dosage field
        const dosageGroup = document.createElement('div');
        dosageGroup.className = 'form-group';
        const dosageLabel = document.createElement('label');
        dosageLabel.setAttribute('for', 'dosage_' + index);
        dosageLabel.textContent = '用法用量：';
        dosageGroup.appendChild(dosageLabel);
        const dosageInput = document.createElement('input');
        dosageInput.type = 'text';
        dosageInput.id = 'dosage_' + index;
        dosageInput.name = 'dosage_' + index;
        dosageInput.value = '按医嘱';
        dosageInput.placeholder = '按医嘱';
        dosageGroup.appendChild(dosageInput);
        container.appendChild(dosageGroup);
        
        // Create duration field
        const durationGroup = document.createElement('div');
        durationGroup.className = 'form-group';
        const durationLabel = document.createElement('label');
        durationLabel.setAttribute('for', 'duration_days_' + index);
        durationLabel.textContent = '疗程（天）：';
        durationGroup.appendChild(durationLabel);
        const durationInput = document.createElement('input');
        durationInput.type = 'number';
        durationInput.id = 'duration_days_' + index;
        durationInput.name = 'duration_days_' + index;
        durationInput.value = '7';
        durationInput.min = '1';
        durationGroup.appendChild(durationInput);
        container.appendChild(durationGroup);
        
        // Create notes field
        const notesGroup = document.createElement('div');
        notesGroup.className = 'form-group';
        const notesLabel = document.createElement('label');
        notesLabel.setAttribute('for', 'notes_' + index);
        notesLabel.textContent = '备注：';
        notesGroup.appendChild(notesLabel);
        const notesInput = document.createElement('textarea');
        notesInput.id = 'notes_' + index;
        notesInput.name = 'notes_' + index;
        notesInput.rows = 2;
        notesGroup.appendChild(notesInput);
        container.appendChild(notesGroup);
        
        // Add separator
        const hr = document.createElement('hr');
        container.appendChild(hr);
        
        return container;
    }
    
    function addPrescription() {
        prescriptionCount++;
        const prescriptionList = document.getElementById('prescriptionList');
        const newPrescription = createPrescriptionElement(prescriptionCount);
        prescriptionList.appendChild(newPrescription);
    }
</script>
{% endblock %}
